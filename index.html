<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Gantt</title>
	<style>
		.container {
			width: 100%;
			margin: 0 auto;
		}
		.gantt-container {
			/*overflow: scroll;*/
		}
		

	</style>
	<script src="node_modules/moment/min/moment.min.js"></script>
	<script src="node_modules/snapsvg/dist/snap.svg-min.js"></script>
	<script src="dist/frappe-gantt.js"></script>
</head>
<body>
	<div class="container">			
		<div class="gantt-container">
			<svg id="gantt" width="400" height="600"></svg>
		</div>
	</div>
	<script>

	function getProjects() {

  const projetos = [];
  let tarefaId = 0;
  let i;
  let j;

  

  for (i = 1; i <= 1; i++) {

    const tarefas = [];
    let dataInicio = new Date('2017-09-02T03:00:00.000Z');
    let duracao = 10;
    let latencia = 11;

    for (j = 1; j <= 15; j++) {

      let resp = [];
      resp = (j % 2 == 0) ? [{
        responsavel_id: '54103757',
        responsavel: {
          chave: 'F4103757',
          nome: 'Henrique Fidellis Ferreira',
          celular: '061 92014477',
          telefone: '061 34937402',
        },
      },
      {
        responsavel_id: '56805293',
        responsavel: {
          chave: 'F6805293',
          nome: 'Marcos Andrei',
          celular: '061 993283558',
          telefone: '061 34937403',
        },
      }] :
      [
      {
        responsavel_id: '56805293',
        responsavel: {
          chave: 'F6805293',
          nome: 'Marcos Andrei',
          celular: '061 993283558',
          telefone: '061 34937403',
        },
      }];

      tarefaId += 1;

      dataInicio = new Date(dataInicio);
      dataInicio.setDate(dataInicio.getDate() + latencia);
      const dataFim = new Date(dataInicio);
      // duracao = moment(dataInicio).daysInMonth() - 1;      
      dataFim.setDate(dataFim.getDate() + duracao);
      // latencia = moment(dataInicio).daysInMonth() + j;

      const tarefa = {

        id: tarefaId,
        sequencia: j,
        percentual: 30,
        tarefaAtual: j === i + 2,
        tarefa: {
          id: j,
          nome: j === 2 ? `Tarefa ${j}` : `Tarefa ${j}`,
        },
        situacao: {
          id: 1,
          nome: 'Não Iniciado',
        },
        periodos: [
          {
            id: 1,
            dataInicio,
            dataFim,

            tipo: {
              id: 1,
              nome: 'Previsão',
            },
          },
          {
            id: 2,
            dataInicio: '2017-06-13T12:53:03.348Z',
            dataFim: '2017-06-14T03:00:00.000Z',

            tipo: {
              id: 2,
              nome: 'Realizado',
            },

          },
          {
            id: 3,
            dataInicio: '2017-06-13T12:53:03.348Z',
            dataFim: '2017-06-14T03:00:00.000Z',

            tipo: {
              id: 2,
              nome: 'Realizado',
            },

          },
        ],
        vinculos: [
          {
            tarefaSubordinada_id: 2,
          },
        ],
        predecessoes: [
          {
            tarefaPredecessao_id: j !== 1 ? tarefaId - 1 : null,
          },
        ],
        responsaveis: resp,
        uors: [
          {
            uor_id: 284651,
            uor: {
              id: 284651,
              nome: 'DISEM - DIVISAO GEST ATIVOS E INFORMA GERENCIAIS',
              nomeReduzido: 'DISEM/DIV INFORM GER',
              prefixo: 9951,
              subordinada: 22,
            },
          },
          // {
          //   uor_id: 284650,
          //   uor: {
          //     id: 284650,
          //     nome: 'DISEM - DIVISAO CONTROLE',
          //     nomeReduzido: 'DISEM/CONTROLE',
          //     prefixo: 9951,
          //     subordinada: 20,
          //   },
          // },
        ],
      };

      tarefas.push(tarefa);

    }

    const projeto =
      {
        id: i,
        nome: `Projeto ${i}`,
        tarefas,
      };

    projetos.push(projeto);

  }

  let projects = [];

  projects = projects.concat(projetos.map((projeto) => {

    const tarefas = projeto.tarefas;

    const tasks = tarefas.map((tarefa) => {

      const previsao = tarefa.periodos.find(periodo => periodo.tipo.id === 1);
      const dependencies = tarefa.predecessoes.map(vinculo => vinculo.tarefaPredecessao_id);

      return {
        projectId: projeto.id,
        id: tarefa.id,
        name: tarefa.tarefa.nome,
        start: previsao.dataInicio,
        end: previsao.dataFim,
        progress: tarefa.percentual,
        dependencies,
        currentTask: tarefa.tarefaAtual,
        periodos: tarefa.periodos,
        responsaveis: tarefa.responsaveis,
        uors: tarefa.uors,
      };

    });

    return {
      id: projeto.id,
      name: projeto.nome,
      tasks,
    };

  }));

  return projects;

}


		// console.log('const projects = ', JSON.stringify(getProjects()))
		
		var gantt_chart = Gantt("#gantt", getProjects(), {
			on_click: function (task) {
				// console.log(task);
			},
			on_date_change: function(task, start, end) {
				console.log(start._d, end._d);
			},
			on_progress_change: function(task, progress) {
				// console.log(task, progress);
			},
			on_view_change: function(mode) {
				// console.log(mode);
			},
			view_mode: 'Month',
			inline: false,
			projection: false,
      left_menu_width: 0,
			// bar: {
			// 	height: 15
			// },
		});

		//console.log(gantt_chart);
		
	</script>
</body>
</html>
