<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Gantt</title>
	<style>
		body {
			font-family: sans-serif;
			/*background: #ccc;*/
		}
		.container {
			width: 100%;
			margin: 0 auto;
		}
		.gantt-container {
			/*overflow: scroll;*/
		}
		

	</style>
	<script src="node_modules/moment/min/moment.min.js"></script>
	<script src="node_modules/snapsvg/dist/snap.svg-min.js"></script>
	<script src="dist/frappe-gantt.js"></script>
</head>
<body>
	<div class="container">			
		<div class="gantt-container">
			<svg id="gantt" width="400" height="600"></svg>
		</div>
	</div>
	<script>

	function getProjects(){
		
			let projetos = [];
			let tarefaId = 0;		

			for(i = 1; i <= 3; i++){
				
				let tarefas = [];			
				let dataInicio = new Date("2017-06-10T03:00:00.000Z");
				let duracao = 0;
				let latencia = 0;			

				for(j = 1; j <= 5; j++){

					tarefaId++;
					
					dataInicio = new Date(dataInicio);
					dataInicio.setDate(dataInicio.getDate() + latencia);				
					dataFim = new Date(dataInicio);
					duracao = moment(dataInicio).daysInMonth() - 1;
					duracao = 30;
					dataFim.setDate(dataFim.getDate() + duracao);
					// latencia = moment(dataInicio).daysInMonth() + j;
					latencia = j*3 + 20;
					
					tarefa = {

						id: tarefaId,
						sequencia: j,					
						percentual: j < i + 2 ? 100: j > i + 2 ? 0 : 20,
						tarefaAtual: j == i + 2 ? true : false,
						tarefa: {
							id: j,
							nome: j == 2 ? "Tarefa " + j : "Tarefa " + j,								
						},
						situacao: {
							id: 1,
							nome: "Não Iniciado"
						},												
						periodos: [
							{
								id: 1,
								dataInicio: dataInicio,
								dataFim: dataFim,
								
								tipo: {
									id: 1,
									nome: "Previsão",																				
								},																
							},
							{
								id: 2,
								dataInicio: "2017-06-13T12:53:03.348Z",
								dataFim: "2017-06-14T03:00:00.000Z",
								
								tipo: {
									id: 2,
									nome: "Realizado",																				
								},
															
							},
						],
						vinculos: [ 
							{
								tarefaSubordinada_id: 2,
							}
						],
						predecessoes: [
							{
								tarefaPredecessao_id: j != 1 ? tarefaId - 1 : null,
							},													
						],
						responsaveis: [
							{
								responsavel_id: "56805293",
								responsavel: {
									chave: "F6805293",
									nome: "Marcos Andrei Ivanechtchuk",
									celular: "061 993283558",
									telefone: 37402
								}
							},
							{
								responsavel_id: "54103757",
								responsavel: {
									chave: "F4103757",
									nome: "Henrique Fidellis Ferreira",
									celular: "061 92014477",
									telefone: 37404
								}
							}
						],
						uors: [
							{
							uor_id: 284651,
							uor: {
									id: 284651,
									nome: "DISEM - DIVISAO GEST ATIVOS E INFORMA GERENCIAIS",
									nomeReduzido: "DISEM/DIV INFORM GER",
									prefixo: 9951,
									subordinada: 22
								}
							},
							{
							uor_id: 284650,
							uor: {
									id: 284650,
									nome: "DISEM - DIVISAO CONTROLE",
									nomeReduzido: "DISEM/CONTROLE",
									prefixo: 9951,
									subordinada: 20
								}
							}
						],					
					};

					tarefas.push(tarefa);
				};			

				projeto = 
					{
						id: i,
						nome: "Projeto " + i,
						tarefas: tarefas,
					};

				projetos.push(projeto)
			}

			let projects = [];		

			projects = projects.concat(projetos.map(projeto =>{

				tarefas = projeto.tarefas;			

				tasks = tarefas.map((tarefa, i) => {
								
					let previsao = tarefa.periodos.find(periodo => periodo.tipo.id == 1)			
					let dependencies = tarefa.predecessoes.map(vinculo => vinculo.tarefaPredecessao_id)
									
					return {
						projectId: projeto.id,
						id: tarefa.id,
						name: tarefa.tarefa.nome,
						start: previsao.dataInicio,
						end: previsao.dataFim,					
						progress: tarefa.percentual,
						dependencies: dependencies,
						currentTask: tarefa.tarefaAtual,
						periodos: tarefa.periodos,
						responsaveis: tarefa.responsaveis,
						uors: tarefa.uors,
					}
				});

				return {
					id: projeto.id,
					name: projeto.nome,
					tasks: tasks,
				}			
			}));

			return projects;
		}


		//console.log('const projects = ', JSON.stringify(getProjects()))
		
		var gantt_chart = Gantt("#gantt", getProjects(), {
			on_click: function (task) {
				console.log(task);
			},
			on_date_change: function(task, start, end) {
				console.log(task, start, end);
			},
			on_progress_change: function(task, progress) {
				console.log(task, progress);
			},
			on_view_change: function(mode) {
				console.log(mode);
			},
			view_mode: 'Month',
			left_width: 150,
			inline: true,
		});
		
		//console.log(gantt_chart);
		
	</script>
</body>
</html>
